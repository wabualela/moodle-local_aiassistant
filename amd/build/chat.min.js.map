{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AI Assistant Chat Interface\n *\n * @module     local_aiassistant/chat\n * @copyright  2025 Wail Abualela\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n\n    const FALLBACK_ERROR_MESSAGE = 'An unexpected error occurred. Please try again later.';\n\n    /**\n     * Chat class to handle AI assistant interaction\n     */\n    class Chat {\n        /**\n         * Constructor\n         */\n        constructor() {\n            this.fab = null;\n            this.chatBox = null;\n            this.messagesContainer = null;\n            this.input = null;\n            this.sendButton = null;\n            this.closeButton = null;\n            this.optionsButton = null;\n            this.attachmentButton = null;\n            this.isOpen = false;\n            this.history = [];\n            this.isSending = false;\n            this.errorMessage = '';\n        }\n\n        /**\n         * Initialize the chat interface\n         */\n        init() {\n            // Get DOM elements\n            this.fab = document.getElementById('local-aiassistant-fab');\n            this.chatBox = document.getElementById('local-aiassistant-chat');\n\n            if (!this.fab || !this.chatBox) {\n                window.console.warn('AI Assistant: Required elements not found');\n                return;\n            }\n\n            this.messagesContainer = this.chatBox.querySelector('#local-aiassistant-messages');\n            this.input = this.chatBox.querySelector('#local-aiassistant-input');\n            this.sendButton = this.chatBox.querySelector('#local-aiassistant-send');\n            this.closeButton = this.chatBox.querySelector('.local-aiassistant-chat-close');\n            this.optionsButton = this.chatBox.querySelector('.local-aiassistant-chat-options');\n            this.attachmentButton = this.chatBox.querySelector('.local-aiassistant-attachment');\n\n            if (this.chatBox && this.chatBox.dataset && this.chatBox.dataset.errorGeneric) {\n                this.errorMessage = this.chatBox.dataset.errorGeneric;\n            } else {\n                this.errorMessage = FALLBACK_ERROR_MESSAGE;\n            }\n\n            // Bind event listeners\n            this.bindEvents();\n\n            window.console.log('AI Assistant Chat initialized');\n        }\n\n        /**\n         * Bind all event listeners\n         */\n        bindEvents() {\n            // FAB click to open chat\n            this.fab.addEventListener('click', () => this.toggleChat());\n\n            // Also handle keyboard navigation for FAB\n            this.fab.addEventListener('keydown', (e) => {\n                if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    this.toggleChat();\n                }\n            });\n\n            // Close button\n            if (this.closeButton) {\n                this.closeButton.addEventListener('click', () => this.closeChat());\n            }\n\n            // Options button\n            if (this.optionsButton) {\n                this.optionsButton.addEventListener('click', () => this.openSettings());\n            }\n\n            // Send button\n            if (this.sendButton) {\n                this.sendButton.addEventListener('click', () => this.sendMessage());\n            }\n\n            // Enter key in input\n            if (this.input) {\n                this.input.addEventListener('keypress', (e) => {\n                    if (e.key === 'Enter' && !e.shiftKey) {\n                        e.preventDefault();\n                        this.sendMessage();\n                    }\n                });\n            }\n\n            // Close chat when clicking outside\n            document.addEventListener('click', (e) => {\n                if (this.isOpen &&\n                    !this.chatBox.contains(e.target) &&\n                    !this.fab.contains(e.target)) {\n                    this.closeChat();\n                }\n            });\n\n            // Prevent closing when clicking inside chat\n            this.chatBox.addEventListener('click', (e) => {\n                e.stopPropagation();\n            });\n        }\n\n        /**\n         * Enable or disable the chat controls while a request is in progress.\n         *\n         * @param {boolean} disabled\n         */\n        setInputDisabled(disabled) {\n            if (this.input) {\n                this.input.disabled = disabled;\n            }\n            if (this.sendButton) {\n                this.sendButton.disabled = disabled;\n            }\n            if (this.attachmentButton) {\n                this.attachmentButton.disabled = disabled;\n            }\n        }\n\n        /**\n         * Toggle chat visibility\n         */\n        toggleChat() {\n            if (this.isOpen) {\n                this.closeChat();\n            } else {\n                this.openChat();\n            }\n        }\n\n        /**\n         * Open the chat interface\n         */\n        openChat() {\n            this.chatBox.classList.add('is-visible');\n            this.fab.classList.add('is-hidden');\n            this.isOpen = true;\n            this.fab.setAttribute('aria-expanded', 'true');\n\n            // Focus on input field\n            if (this.input) {\n                setTimeout(() => this.input.focus(), 100);\n            }\n        }\n\n        /**\n         * Close the chat interface\n         */\n        closeChat() {\n            this.chatBox.classList.remove('is-visible');\n            this.fab.classList.remove('is-hidden');\n            this.isOpen = false;\n            this.fab.setAttribute('aria-expanded', 'false');\n        }\n\n        /**\n         * Open settings page\n         */\n        openSettings() {\n            const settingsUrl = this.chatBox.getAttribute('data-settingsurl');\n            if (settingsUrl) {\n                window.location.href = settingsUrl;\n            }\n        }\n\n        /**\n         * Send a message\n         */\n        sendMessage() {\n            if (this.isSending) {\n                return;\n            }\n\n            const message = this.input.value.trim();\n\n            if (message === '') {\n                return;\n            }\n\n            const historyPayload = this.history.map((entry) => ({\n                message: entry.message\n            }));\n\n            // Add user message to UI\n            this.addMessage(message, 'user');\n\n            // Clear input\n            this.input.value = '';\n\n            // Persist user message for future turns.\n            this.history.push({sender: 'user', message: message});\n\n            // Show typing indicator\n            this.showTypingIndicator();\n\n            this.setInputDisabled(true);\n            this.isSending = true;\n\n            Ajax.call([{\n                methodname: 'local_aiassistant_get_completion',\n                args: {\n                    message: message,\n                    history: historyPayload,\n                },\n            }])[0]\n                .then((response) => {\n                    window.console.log('AI Response received:', response);\n                    if (response.success) {\n                        const content = response.formattedmessage || response.message;\n                        window.console.log('Adding AI message, renderAsHtml:', Boolean(response.formattedmessage));\n                        this.addMessage(content, 'ai', {\n                            renderAsHtml: Boolean(response.formattedmessage),\n                        });\n                        this.history.push({sender: 'ai', message: response.message});\n                    } else {\n                        window.console.log('AI Response failed:', response.message);\n                        const errortext = response.message || this.errorMessage;\n                        this.addMessage(errortext, 'ai', {\n                            isError: true,\n                        });\n                    }\n\n                    // Cleanup after successful response\n                    window.console.log('Cleaning up after response');\n                    this.hideTypingIndicator();\n                    this.setInputDisabled(false);\n                    this.isSending = false;\n                    if (this.input) {\n                        this.input.focus();\n                    }\n                })\n                .catch((error) => {\n                    window.console.error('Ajax call failed:', error);\n                    Notification.exception(error);\n                    this.addMessage(this.errorMessage, 'ai', {\n                        isError: true,\n                    });\n\n                    // Cleanup after error\n                    window.console.log('Cleaning up after error');\n                    this.hideTypingIndicator();\n                    this.setInputDisabled(false);\n                    this.isSending = false;\n                    if (this.input) {\n                        this.input.focus();\n                    }\n                });\n        }\n\n        /**\n         * Add a message to the chat\n         *\n         * @param {string} text - The message text\n         * @param {string} sender - Either 'user' or 'ai'\n         * @param {Object} options - Additional options for rendering the message\n         */\n        addMessage(text, sender, options = {}) {\n            const renderAsHtml = options.renderAsHtml || false;\n            const isError = options.isError || false;\n\n            window.console.log('addMessage called:', {sender, renderAsHtml, isError, textLength: text.length});\n\n            const messageDiv = document.createElement('div');\n            messageDiv.className = `local-aiassistant-message local-aiassistant-message-${sender}`;\n            if (isError) {\n                messageDiv.classList.add('local-aiassistant-message-error');\n            }\n\n            const contentDiv = document.createElement('div');\n            contentDiv.className = 'local-aiassistant-message-content';\n            if (renderAsHtml) {\n                // Sanitize and render HTML safely\n                contentDiv.innerHTML = text;\n                // Remove any script tags that might have been added\n                const scripts = contentDiv.querySelectorAll('script');\n                scripts.forEach(script => script.remove());\n            } else {\n                contentDiv.textContent = text;\n            }\n\n            const timeDiv = document.createElement('div');\n            timeDiv.className = 'local-aiassistant-message-time';\n            timeDiv.textContent = this.getCurrentTime();\n\n            messageDiv.appendChild(contentDiv);\n            messageDiv.appendChild(timeDiv);\n\n            this.messagesContainer.appendChild(messageDiv);\n\n            window.console.log('Message added to DOM');\n\n            // Scroll to bottom\n            this.scrollToBottom();\n        }\n\n        /**\n         * Show typing indicator\n         */\n        showTypingIndicator() {\n            this.hideTypingIndicator();\n            const indicator = document.createElement('div');\n            indicator.className = 'local-aiassistant-typing-indicator';\n            indicator.id = 'local-aiassistant-typing';\n            indicator.innerHTML = '<span></span><span></span><span></span>';\n\n            this.messagesContainer.appendChild(indicator);\n            this.scrollToBottom();\n        }\n\n        /**\n         * Hide typing indicator\n         */\n        hideTypingIndicator() {\n            const indicator = document.getElementById('local-aiassistant-typing');\n            if (indicator) {\n                indicator.remove();\n            }\n        }\n\n        /**\n         * Scroll messages to bottom\n         */\n        scrollToBottom() {\n            this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;\n        }\n\n        /**\n         * Get current time formatted\n         *\n         * @returns {string} Formatted time\n         */\n        getCurrentTime() {\n            const now = new Date();\n            return now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});\n        }\n    }\n\n    return {\n        /**\n         * Initialize the chat module\n         */\n        init: function() {\n            // Wait for DOM to be ready\n            $(document).ready(function() {\n                const chat = new Chat();\n                chat.init();\n            });\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Chat","constructor","fab","chatBox","messagesContainer","input","sendButton","closeButton","optionsButton","attachmentButton","isOpen","history","isSending","errorMessage","init","document","getElementById","this","querySelector","dataset","errorGeneric","bindEvents","window","console","log","warn","addEventListener","toggleChat","e","key","preventDefault","closeChat","openSettings","sendMessage","shiftKey","contains","target","stopPropagation","setInputDisabled","disabled","openChat","classList","add","setAttribute","setTimeout","focus","remove","settingsUrl","getAttribute","location","href","message","value","trim","historyPayload","map","entry","addMessage","push","sender","showTypingIndicator","call","methodname","args","then","response","success","content","formattedmessage","Boolean","renderAsHtml","errortext","isError","hideTypingIndicator","catch","error","exception","text","options","textLength","length","messageDiv","createElement","className","contentDiv","innerHTML","querySelectorAll","forEach","script","textContent","timeDiv","getCurrentTime","appendChild","scrollToBottom","indicator","id","scrollTop","scrollHeight","Date","toLocaleTimeString","hour","minute","ready"],"mappings":"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"}